- hosts: servers
  become: yes
  vars_files:
    - users.yml

  tasks:
    - name: Create users
      user:
        name: "{{ item.username }}"
        password: "{{ item.password | password_hash('sha512') }}"
        shell: /bin/bash
        create_home: yes
      loop: "{{ users }}"

    - name: Install UFW and OpenSSH Server
      apt:
        name:
          - ufw
          - openssh-server
        state: present
        update_cache: yes

    - name: Ensure UFW is enabled
      community.general.ufw:
        state: enabled

    - name: Allow default SSH port (22)
      community.general.ufw:
        rule: allow
        port: "22"
        proto: tcp

    - name: Allow SSH ports for each user
      community.general.ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: tcp
      loop: "{{ users }}"

    - name: Ensure sshd_config has Port 22
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^Port 22'
        line: 'Port 22'
        state: present

    - name: Add user-specific SSH ports to sshd_config
      lineinfile:
        path: /etc/ssh/sshd_config
        insertafter: '^Port 22'
        line: "Port {{ item.port }}"
        state: present
      loop: "{{ users }}"

    - name: Disable root login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present

    - name: Restart SSH service
      service:
        name: ssh
        state: restarted
